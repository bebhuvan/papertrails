name: Fetch RSS Feeds - Batch 2 (Fast Non-Substack)

on:
  schedule:
    # Run at 5 2:00 UTC
    - cron: '5 2 * * *'
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test with first 5 feeds only'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write

jobs:
  fetch-feeds-batch-2:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm install
        
      - name: Create feed subset file
        run: |
          # Create subset of feeds for this workflow
          cat > workflow-feeds.json << 'EOF'
[
  {
    "name": "Silver Bulletin",
    "slug": "silver-bulletin",
    "url": "https://www.natesilver.net/feed",
    "category": "Politics",
    "defaultAuthor": "Nate Silver"
  },
  {
    "name": "Noahpinion",
    "slug": "noahpinion",
    "url": "https://www.noahpinion.blog/feed",
    "category": "Economics",
    "defaultAuthor": "Noah Smith"
  },
  {
    "name": "Noema",
    "slug": "noema",
    "url": "https://www.noemamag.com/?feed=noemarss",
    "category": "Philosophy",
    "defaultAuthor": "Noema"
  },
  {
    "name": "Not Boring",
    "slug": "not-boring",
    "url": "https://www.notboring.co/feed",
    "category": "Economics",
    "defaultAuthor": "Packy McCormick"
  },
  {
    "name": "n+1",
    "slug": "n-plus-one",
    "url": "https://www.nplusonemag.com/feed/",
    "category": "Culture",
    "defaultAuthor": "n+1"
  },
  {
    "name": "Pens and Poison",
    "slug": "pens-and-poison",
    "url": "https://www.pensandpoison.org/feed",
    "category": "Culture",
    "defaultAuthor": "Pens and Poison"
  },
  {
    "name": "Programmable Mutter",
    "slug": "programmable-mutter",
    "url": "https://www.programmablemutter.com/feed",
    "category": "Technology",
    "defaultAuthor": "Programmable Mutter"
  },
  {
    "name": "Quanta Magazine",
    "slug": "quanta-magazine",
    "url": "https://www.quantamagazine.org/feed/",
    "category": "Science",
    "defaultAuthor": "Quanta Magazine"
  },
  {
    "name": "Slow Boring",
    "slug": "slow-boring",
    "url": "https://www.slowboring.com/feed",
    "category": "Politics",
    "defaultAuthor": "Matthew Yglesias"
  },
  {
    "name": "Sustainability by Numbers",
    "slug": "sustainability-by-numbers",
    "url": "https://www.sustainabilitybynumbers.com/feed",
    "category": "Science",
    "defaultAuthor": "Hannah Ritchie"
  },
  {
    "name": "The Marginalian",
    "slug": "the-marginalian",
    "url": "https://www.themarginalian.org/feed/",
    "category": "Culture",
    "defaultAuthor": "Maria Popova"
  },
  {
    "name": "Woman of Letters",
    "slug": "woman-of-letters",
    "url": "https://www.woman-of-letters.com/feed",
    "category": "Culture",
    "defaultAuthor": "Woman of Letters"
  },
  {
    "name": "Works in Progress",
    "slug": "works-in-progress",
    "url": "https://www.worksinprogress.news/feed",
    "category": "Science",
    "defaultAuthor": "Works in Progress"
  },
  {
    "name": "Letters of Note",
    "slug": "letters-of-note",
    "url": "https://news.lettersofnote.com/feed",
    "category": "Culture",
    "defaultAuthor": "Letters of Note"
  },
  {
    "name": "Vik's Newsletter",
    "slug": "viks-newsletter",
    "url": "https://www.viksnewsletter.com/feed",
    "category": "Technology",
    "defaultAuthor": "Vik's Newsletter"
  },
  {
    "name": "The Algorithmic Bridge",
    "slug": "algorithmic-bridge",
    "url": "https://www.thealgorithmicbridge.com/feed",
    "category": "Technology",
    "defaultAuthor": "The Algorithmic Bridge"
  },
  {
    "name": "The Culturist",
    "slug": "the-culturist",
    "url": "https://www.theculturist.io/feed",
    "category": "Culture",
    "defaultAuthor": "The Culturist"
  },
  {
    "name": "Nadig",
    "slug": "nadig",
    "url": "https://www.nadig.com/feed",
    "category": "Economics",
    "defaultAuthor": "Nadig"
  },
  {
    "name": "Blood in the Machine",
    "slug": "blood-in-the-machine",
    "url": "https://www.bloodinthemachine.com/feed",
    "category": "Culture",
    "defaultAuthor": "Brian Merchant"
  },
  {
    "name": "Jacob Silverman",
    "slug": "jacob-silverman",
    "url": "https://www.jacobsilverman.com/feed",
    "category": "Culture",
    "defaultAuthor": "Jacob Silverman"
  },
  {
    "name": "The Present Age",
    "slug": "the-present-age",
    "url": "https://www.readtpa.com/feed",
    "category": "Culture",
    "defaultAuthor": "The Present Age"
  },
  {
    "name": "Pluralistic",
    "slug": "pluralistic",
    "url": "https://pluralistic.net/feed",
    "category": "Technology",
    "defaultAuthor": "Cory Doctorow"
  },
  {
    "name": "Nintil",
    "slug": "nintil",
    "url": "https://nintil.com/rss.xml",
    "category": "Science",
    "defaultAuthor": "Nintil"
  },
  {
    "name": "Maggie Appleton",
    "slug": "maggie-appleton",
    "url": "https://maggieappleton.com/rss.xml",
    "category": "Technology",
    "defaultAuthor": "Maggie Appleton"
  },
  {
    "name": "Interconnected",
    "slug": "interconnected",
    "url": "https://interconnected.org/home/feed",
    "category": "Technology",
    "defaultAuthor": "Matt Webb"
  }
]
EOF
        
      - name: Fetch RSS feeds subset
        run: |
          # Create custom fetcher for this subset
          cat > fetch-subset.js << 'EOF'
import fs from 'fs/promises';
const feeds = JSON.parse(await fs.readFile('workflow-feeds.json', 'utf-8'));

// Limit for testing if requested
const testMode = process.env.TEST_MODE === 'true';
const feedsToProcess = testMode ? feeds.slice(0, 5) : feeds;

console.log(`Processing ${feedsToProcess.length} feeds for Batch 2 (Fast Non-Substack)`);
console.log(`Base delay: 8 seconds`);

// Set environment for existing fetcher
process.env.WORKFLOW_FEEDS = JSON.stringify(feedsToProcess);
process.env.BASE_DELAY = '8';
process.env.WORKFLOW_NAME = 'batch-2';

// Import and run modified fetcher
await import('./src/scripts/fetch-feeds-parallel.js');
EOF

          node fetch-subset.js
        env:
          TEST_MODE: ${{ github.event.inputs.test_mode }}
        timeout-minutes: 80
        
      - name: Commit and push if changes
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions - Batch 2 (Fast Non-Substack)"
          
          # Check for changes
          if git diff --quiet data/articles.json; then
            echo "No new articles found"
          else
            git add data/articles.json data/articles-archive.json
            
            # Count new articles
            NEW_COUNT=$(git diff --cached data/articles.json | grep -c '^+.*"title"' || echo "0")
            
            git commit -m "ðŸ“° Update feeds: Batch 2 (Fast Non-Substack) - ${NEW_COUNT} articles - $(date -u +"%Y-%m-%d %H:%M UTC")"
            
            # Push with retry logic
            for i in {1..3}; do
              if git push; then
                echo "âœ… Successfully pushed on attempt $i"
                break
              else
                echo "âš ï¸ Push attempt $i failed, retrying in 30s..."
                sleep 30
                git pull --rebase
              fi
            done
          fi
        
      - name: Report results
        if: always()
        run: |
          echo "## Batch 2 (Fast Non-Substack) Results" >> $GITHUB_STEP_SUMMARY
          echo "- Feeds processed: 25" >> $GITHUB_STEP_SUMMARY  
          echo "- Substack feeds: $(echo '[{"name":"Silver Bulletin","slug":"silver-bulletin","url":"https://www.natesilver.net/feed","category":"Politics","defaultAuthor":"Nate Silver"},{"name":"Noahpinion","slug":"noahpinion","url":"https://www.noahpinion.blog/feed","category":"Economics","defaultAuthor":"Noah Smith"},{"name":"Noema","slug":"noema","url":"https://www.noemamag.com/?feed=noemarss","category":"Philosophy","defaultAuthor":"Noema"},{"name":"Not Boring","slug":"not-boring","url":"https://www.notboring.co/feed","category":"Economics","defaultAuthor":"Packy McCormick"},{"name":"n+1","slug":"n-plus-one","url":"https://www.nplusonemag.com/feed/","category":"Culture","defaultAuthor":"n+1"},{"name":"Pens and Poison","slug":"pens-and-poison","url":"https://www.pensandpoison.org/feed","category":"Culture","defaultAuthor":"Pens and Poison"},{"name":"Programmable Mutter","slug":"programmable-mutter","url":"https://www.programmablemutter.com/feed","category":"Technology","defaultAuthor":"Programmable Mutter"},{"name":"Quanta Magazine","slug":"quanta-magazine","url":"https://www.quantamagazine.org/feed/","category":"Science","defaultAuthor":"Quanta Magazine"},{"name":"Slow Boring","slug":"slow-boring","url":"https://www.slowboring.com/feed","category":"Politics","defaultAuthor":"Matthew Yglesias"},{"name":"Sustainability by Numbers","slug":"sustainability-by-numbers","url":"https://www.sustainabilitybynumbers.com/feed","category":"Science","defaultAuthor":"Hannah Ritchie"},{"name":"The Marginalian","slug":"the-marginalian","url":"https://www.themarginalian.org/feed/","category":"Culture","defaultAuthor":"Maria Popova"},{"name":"Woman of Letters","slug":"woman-of-letters","url":"https://www.woman-of-letters.com/feed","category":"Culture","defaultAuthor":"Woman of Letters"},{"name":"Works in Progress","slug":"works-in-progress","url":"https://www.worksinprogress.news/feed","category":"Science","defaultAuthor":"Works in Progress"},{"name":"Letters of Note","slug":"letters-of-note","url":"https://news.lettersofnote.com/feed","category":"Culture","defaultAuthor":"Letters of Note"},{"name":"Vik's Newsletter","slug":"viks-newsletter","url":"https://www.viksnewsletter.com/feed","category":"Technology","defaultAuthor":"Vik's Newsletter"},{"name":"The Algorithmic Bridge","slug":"algorithmic-bridge","url":"https://www.thealgorithmicbridge.com/feed","category":"Technology","defaultAuthor":"The Algorithmic Bridge"},{"name":"The Culturist","slug":"the-culturist","url":"https://www.theculturist.io/feed","category":"Culture","defaultAuthor":"The Culturist"},{"name":"Nadig","slug":"nadig","url":"https://www.nadig.com/feed","category":"Economics","defaultAuthor":"Nadig"},{"name":"Blood in the Machine","slug":"blood-in-the-machine","url":"https://www.bloodinthemachine.com/feed","category":"Culture","defaultAuthor":"Brian Merchant"},{"name":"Jacob Silverman","slug":"jacob-silverman","url":"https://www.jacobsilverman.com/feed","category":"Culture","defaultAuthor":"Jacob Silverman"},{"name":"The Present Age","slug":"the-present-age","url":"https://www.readtpa.com/feed","category":"Culture","defaultAuthor":"The Present Age"},{"name":"Pluralistic","slug":"pluralistic","url":"https://pluralistic.net/feed","category":"Technology","defaultAuthor":"Cory Doctorow"},{"name":"Nintil","slug":"nintil","url":"https://nintil.com/rss.xml","category":"Science","defaultAuthor":"Nintil"},{"name":"Maggie Appleton","slug":"maggie-appleton","url":"https://maggieappleton.com/rss.xml","category":"Technology","defaultAuthor":"Maggie Appleton"},{"name":"Interconnected","slug":"interconnected","url":"https://interconnected.org/home/feed","category":"Technology","defaultAuthor":"Matt Webb"}]' | grep -o 'substack.com' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- Base delay: 8s" >> $GITHUB_STEP_SUMMARY
