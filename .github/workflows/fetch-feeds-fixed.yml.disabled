name: Fetch RSS Feeds (Fixed Compression)

on:
  schedule:
    # Run every 6 hours at optimal times
    - cron: '0 2,8,14,20 * * *'
  workflow_dispatch:
    inputs:
      test_run:
        description: 'Run with limited feeds for testing'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write

jobs:
  fetch-feeds:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm install
        
      - name: Fetch RSS feeds
        run: |
          if [ "${{ github.event.inputs.test_run }}" = "true" ]; then
            echo "Running test with limited feeds..."
            # Modify script for test run
            sed -i 's/const orderedFeeds = \[\.\.\.\otherFeeds, \.\.\.substackFeeds\];/const orderedFeeds = [...otherFeeds.slice(0, 5), ...substackFeeds.slice(0, 3)];/' src/scripts/fetch-feeds-local.js
          fi
          
          # Use our proven working local fetcher
          node src/scripts/fetch-feeds-local.js
        timeout-minutes: 45
        
      - name: Commit and push if changes
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions - RSS Fetcher"
          
          # Check if there are changes
          if git diff --quiet data/articles.json; then
            echo "No changes to articles.json"
          else
            git add data/articles.json data/articles-archive.json
            
            # Get summary for commit message
            NEW_COUNT=$(git diff --staged data/articles.json | grep -c '^+.*"title"' || echo "0")
            
            if [ "${{ github.event.inputs.test_run }}" = "true" ]; then
              COMMIT_MSG="üß™ Test run: Update RSS feeds - ${NEW_COUNT} new articles"
            else
              COMMIT_MSG="üì∞ Auto-update RSS feeds - ${NEW_COUNT} new articles"
            fi
            
            git commit -m "${COMMIT_MSG} - $(date -u +"%Y-%m-%d %H:%M UTC")"
            git push
            
            echo "‚úÖ Pushed ${NEW_COUNT} new articles"
          fi
        
      - name: Report results
        if: always()
        run: |
          if [ -f /tmp/fetch-results.json ]; then
            echo "üìä Fetch Results:"
            cat /tmp/fetch-results.json
          else
            echo "‚ÑπÔ∏è  No detailed results available"
          fi